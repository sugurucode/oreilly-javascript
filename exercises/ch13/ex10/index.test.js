import { jest } from '@jest/globals';
import { fetchSumOfFileSizes } from './index.ts';
// --- テスト用モック関数を先に定義 ---
const readdirMock = jest.fn();
const statMock = jest.fn();
const joinMock = jest.fn((...args) => args.join('/'));
// --- モジュールのモック ---
jest.mock('fs/promises', () => ({
    readdir: readdirMock,
    stat: statMock,
}));
jest.mock('path', () => ({
    join: joinMock,
}));
// Stats の簡易モック型
function createStats(size, isFile) {
    return {
        size,
        isFile: () => isFile,
        atime: new Date(),
        mtime: new Date(),
        ctime: new Date(),
        birthtime: new Date(),
        atimeMs: 0,
        mtimeMs: 0,
        ctimeMs: 0,
        birthtimeMs: 0,
        isDirectory: () => !isFile,
        isBlockDevice: () => false,
        isCharacterDevice: () => false,
        isSymbolicLink: () => false,
        isFIFO: () => false,
        isSocket: () => false,
    };
}
describe('fetchSumOfFileSizes', () => {
    beforeEach(() => {
        readdirMock.mockClear();
        statMock.mockClear();
        joinMock.mockClear();
    });
    test('複数のファイルの合計サイズを正しく計算できる', async () => {
        readdirMock.mockResolvedValue(['file1.txt', 'file2.png', 'subdir']);
        statMock
            .mockResolvedValueOnce(createStats(100, true))
            .mockResolvedValueOnce(createStats(250, true))
            .mockResolvedValueOnce(createStats(4096, false));
        const totalSize = await fetchSumOfFileSizes('dummy/path');
        expect(totalSize).toBe(350);
        expect(joinMock).toHaveBeenCalledWith('dummy/path', 'file1.txt');
        expect(joinMock).toHaveBeenCalledWith('dummy/path', 'file2.png');
        expect(joinMock).toHaveBeenCalledWith('dummy/path', 'subdir');
    });
    test('ディレクトリが空の場合、0を返す', async () => {
        readdirMock.mockResolvedValue([]);
        const totalSize = await fetchSumOfFileSizes('empty/dir');
        expect(totalSize).toBe(0);
        expect(readdirMock).toHaveBeenCalledWith('empty/dir');
        expect(statMock).not.toHaveBeenCalled();
    });
    test('ディレクトリの読み取りに失敗した場合、0を返す', async () => {
        readdirMock.mockRejectedValue(new Error('Permission denied'));
        const totalSize = await fetchSumOfFileSizes('locked/dir');
        expect(totalSize).toBe(0);
    });
    test('一部のファイルのstat取得に失敗しても、他のファイルの合計を返す', async () => {
        readdirMock.mockResolvedValue(['fileA.txt', 'inaccessible.file', 'fileB.txt']);
        statMock
            .mockResolvedValueOnce(createStats(50, true))
            .mockRejectedValueOnce(new Error('Access denied'))
            .mockResolvedValueOnce(createStats(150, true));
        const totalSize = await fetchSumOfFileSizes('mixed/path');
        expect(totalSize).toBe(200);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXgudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImluZGV4LnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFFakQseUJBQXlCO0FBQ3pCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUM5QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7QUFDM0IsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBYyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFFaEUsb0JBQW9CO0FBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDOUIsT0FBTyxFQUFFLFdBQVc7SUFDcEIsSUFBSSxFQUFFLFFBQVE7Q0FDZixDQUFDLENBQUMsQ0FBQztBQUNKLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDdkIsSUFBSSxFQUFFLFFBQVE7Q0FDZixDQUFDLENBQUMsQ0FBQztBQUVKLGdCQUFnQjtBQUNoQixTQUFTLFdBQVcsQ0FBQyxJQUFZLEVBQUUsTUFBZTtJQUNoRCxPQUFPO1FBQ0wsSUFBSTtRQUNKLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxNQUFNO1FBQ3BCLEtBQUssRUFBRSxJQUFJLElBQUksRUFBRTtRQUNqQixLQUFLLEVBQUUsSUFBSSxJQUFJLEVBQUU7UUFDakIsS0FBSyxFQUFFLElBQUksSUFBSSxFQUFFO1FBQ2pCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtRQUNyQixPQUFPLEVBQUUsQ0FBQztRQUNWLE9BQU8sRUFBRSxDQUFDO1FB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